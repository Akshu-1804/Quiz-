<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Calculus | Premium Quiz Engine</title>
    <!-- Tailwind CSS for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: #f8fafc;
            overflow-x: hidden;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .view {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .view.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .btn-premium {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px var(--accent-primary);
            filter: brightness(1.1);
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .input-glass:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Animated background particles */
        .bg-glow {
            position: fixed;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent-primary), transparent 70%);
            opacity: 0.15;
            filter: blur(60px);
            z-index: -1;
            border-radius: 50%;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .option-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .option-btn.selected {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 0.4;
            }

            50% {
                opacity: 0.7;
            }
        }

        .pulse {
            animation: pulse-soft 2s infinite;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Background Elements -->
    <div class="bg-glow" style="top: -100px; left: -100px;"></div>
    <div class="bg-glow"
        style="bottom: -100px; right: -100px; background: radial-gradient(circle, var(--accent-secondary), transparent 70%);">
    </div>

    <div class="max-w-xl w-full">
        <!-- Main Application Container -->
        <div id="main-container" class="glass-panel p-8 rounded-3xl overflow-hidden relative">

            <!-- Logo Section -->
            <div class="flex items-center justify-center mb-10 gap-2">
                <div class="p-2 bg-blue-500 rounded-lg">
                    <i data-lucide="graduation-cap" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="text-2xl font-black tracking-tighter text-white">CAREER<span
                        class="text-blue-500 font-light">CALCULUS</span></h1>
            </div>

            <!-- View: Auth (Login/Register) -->
            <div id="auth-view" class="view active">
                <div class="text-center mb-8">
                    <h2 id="auth-title" class="text-3xl font-bold text-white mb-2">Welcome Back</h2>
                    <p id="auth-desc" class="text-slate-400">Please sign in to your account</p>
                </div>

                <form id="auth-form" class="space-y-4">
                    <div>
                        <label
                            class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 ml-1">Email
                            Address</label>
                        <input type="email" id="email" required placeholder="name@example.com"
                            class="w-full input-glass p-4 rounded-xl text-sm">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 ml-1">Password</label>
                        <input type="password" id="password" required placeholder="••••••••"
                            class="w-full input-glass p-4 rounded-xl text-sm">
                    </div>

                    <button id="auth-submit-btn" type="submit"
                        class="w-full btn-premium py-4 rounded-xl font-bold text-white shadow-lg mt-4 flex items-center justify-center gap-2">
                        <span>Sign In</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>

                    <p id="auth-error-msg"
                        class="text-rose-400 text-sm text-center font-medium bg-rose-400/10 py-2 rounded-lg hidden"></p>
                </form>

                <div class="mt-8 text-center pt-6 border-t border-white/5">
                    <p class="text-slate-400 text-sm">
                        <span id="auth-switch-text">Don't have an account?</span>
                        <button id="auth-switch-btn"
                            class="text-blue-400 font-bold hover:text-blue-300 ml-1 transition">Create Account</button>
                    </p>
                </div>
            </div>

            <!-- View: Dashboard / Start -->
            <div id="start-view" class="view">
                <div class="text-center">
                    <div
                        class="w-20 h-20 bg-blue-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-blue-500/30">
                        <i data-lucide="brain-circuit" class="text-blue-400 w-10 h-10"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-white mb-2">Quiz Masterclass</h2>
                    <p class="text-slate-400 mb-8 max-w-sm mx-auto">Select a category to begin your assessment.</p>

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="selectTopic('calculus', this)"
                            class="topic-btn glass-panel p-4 rounded-xl text-sm font-semibold border-blue-500/50 bg-blue-500/10 text-white">Calculus</button>
                        <button onclick="selectTopic('math', this)"
                            class="topic-btn glass-panel p-4 rounded-xl text-sm font-semibold text-slate-400 hover:text-white transition-all">Mathematics</button>
                        <button onclick="selectTopic('logic', this)"
                            class="topic-btn glass-panel p-4 rounded-xl text-sm font-semibold text-slate-400 hover:text-white transition-all">Logic
                            & Reasoning</button>
                        <button onclick="selectTopic('language', this)"
                            class="topic-btn glass-panel p-4 rounded-xl text-sm font-semibold text-slate-400 hover:text-white transition-all">Language</button>
                        <button onclick="selectTopic('comprehension', this)"
                            class="topic-btn glass-panel p-4 rounded-xl text-sm font-semibold text-slate-400 hover:text-white transition-all">Comprehension</button>
                        <button onclick="selectTopic('vocabulary', this)"
                            class="topic-btn glass-panel p-4 rounded-xl text-sm font-semibold text-slate-400 hover:text-white transition-all">Vocabulary</button>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl mb-8 bg-white/5">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Question
                                Count</span>
                            <span id="count-display" class="text-blue-400 font-bold">10 Questions</span>
                        </div>
                        <input type="range" id="q-count" min="5" max="10" value="10" step="1"
                            class="w-full h-1.5 bg-blue-500/20 rounded-lg appearance-none cursor-pointer accent-blue-500"
                            oninput="document.getElementById('count-display').innerText = this.value + ' Questions'">
                    </div>

                    <button id="start-btn"
                        class="w-full btn-premium py-4 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2">
                        <span>Start Examination</span>
                        <i data-lucide="zap" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- View: Quiz -->
            <div id="quiz-view" class="view">
                <div id="loading-spinner" class="py-20 text-center">
                    <div class="flex justify-center mb-6">
                        <div class="w-12 h-12 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin">
                        </div>
                    </div>
                    <p class="text-slate-400 font-medium animate-pulse">Initializing n8n Workflow...</p>
                    <p class="text-xs text-slate-500 mt-2">Fetching randomized questions</p>
                </div>

                <div id="question-container" class="hidden">
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex items-center gap-2">
                            <i data-lucide="layout-grid" class="w-4 h-4 text-blue-500"></i>
                            <span id="progress-text"
                                class="text-xs font-bold text-slate-400 uppercase tracking-widest">Question 1 /
                                10</span>
                        </div>
                        <div class="h-1.5 w-32 bg-white/10 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500"
                                style="width: 10%"></div>
                        </div>
                    </div>

                    <h3 id="question-text" class="text-xl font-semibold text-white mb-8 leading-relaxed"></h3>

                    <div id="options-container" class="space-y-3">
                        <!-- Options will be injected here -->
                    </div>

                    <div class="mt-10 flex gap-3">
                        <button id="next-btn" disabled
                            class="flex-1 btn-premium py-4 rounded-xl font-bold text-white shadow-lg disabled:opacity-30 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2 transition-all">
                            <span id="next-btn-text">Next Question</span>
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- View: Results -->
            <div id="results-view" class="view">
                <div class="text-center">
                    <div id="result-icon-container"
                        class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i id="result-icon" data-lucide="trophy" class="w-12 h-12"></i>
                    </div>

                    <h2 class="text-3xl font-bold text-white mb-2">Test Completed</h2>
                    <p class="text-slate-400 mb-8" id="user-display-email"></p>

                    <div class="glass-panel p-8 rounded-3xl bg-white/5 mb-8">
                        <span class="block text-sm text-slate-500 uppercase font-black mb-2">Final Score</span>
                        <div class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500"
                            id="final-score">
                            0%
                        </div>
                    </div>

                    <p id="score-message" class="text-slate-300 mb-8 font-medium"></p>

                    <button onclick="location.reload()"
                        class="w-full bg-white/10 hover:bg-white/20 text-white py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Restart Quiz</span>
                    </button>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <p class="text-center text-slate-600 text-[10px] mt-8 uppercase tracking-[0.2em] font-bold">
            Powered by n8n & Career Calculus Quiz Engine
        </p>
    </div>

    <script>
        const N8N_WEBHOOK_URL = 'https://akshu18.app.n8n.cloud/webhook/calcus-test';
        const BACKEND_URL = 'http://localhost:5000/api';

        let currentQuestions = [];
        let currentIdx = 0;
        let userAnswers = [];
        let userEmail = "";
        let selectedTopic = 'calculus';
        let isRegisterMode = false;

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => {
                v.classList.remove('active');
                setTimeout(() => { if (!v.classList.contains('active')) v.style.display = 'none'; }, 400);
            });
            const target = document.getElementById(viewId);
            target.style.display = 'block';
            setTimeout(() => target.classList.add('active'), 10);
            lucide.createIcons();
        }

        function selectTopic(topic, btn) {
            selectedTopic = topic;
            document.querySelectorAll('.topic-btn').forEach(b => {
                b.classList.remove('border-blue-500/50', 'bg-blue-500/10', 'text-white');
                b.classList.add('text-slate-400');
            });
            btn.classList.add('border-blue-500/50', 'bg-blue-500/10', 'text-white');
            btn.classList.remove('text-slate-400');
        }

        // Toggle Login vs Register
        document.getElementById('auth-switch-btn').addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? "Create Account" : "Welcome Back";
            document.getElementById('auth-desc').innerText = isRegisterMode ? "Register to start your assessment" : "Please sign in to your account";
            document.getElementById('auth-submit-btn').querySelector('span').innerText = isRegisterMode ? "Register Now" : "Sign In";
            document.getElementById('auth-switch-text').innerText = isRegisterMode ? "Already have an account?" : "Don't have an account?";
            document.getElementById('auth-switch-btn').innerText = isRegisterMode ? "Sign In" : "Create Account";
        });

        // Backend Helper
        async function callBackend(endpoint, method = 'POST', data = {}) {
            try {
                const response = await fetch(`${BACKEND_URL}${endpoint}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Backend Error');
                return result;
            } catch (error) {
                console.error("Backend Error:", error);
                throw error;
            }
        }

        // Auth Form Submit
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('auth-error-msg');
            errorMsg.classList.add('hidden');

            try {
                const endpoint = isRegisterMode ? '/auth/register' : '/auth/login';
                const result = await callBackend(endpoint, 'POST', { email, password });

                if (isRegisterMode) {
                    alert("Registration successful! Please sign in.");
                    isRegisterMode = false;
                    document.getElementById('auth-switch-btn').click();
                } else {
                    userEmail = email;
                    showView('start-view');
                }
            } catch (err) {
                errorMsg.innerText = err.message;
                errorMsg.classList.remove('hidden');
            }
        });

        async function callN8n(action, data = {}) {
            try {
                const url = new URL(N8N_WEBHOOK_URL);
                url.searchParams.append('action', action);
                const response = await fetch(url.toString(), {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action, ...data })
                });
                const text = await response.text();
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                if (!text || text.trim() === "") throw new Error("EMPTY_RESPONSE");
                return JSON.parse(text);
            } catch (error) {
                console.error("n8n Error:", error);
                throw error;
            }
        }

        document.getElementById('start-btn').addEventListener('click', async () => {
            const count = parseInt(document.getElementById('q-count').value);
            showView('quiz-view');
            currentIdx = 0;
            userAnswers = [];

            try {
                const response = await callN8n('get_questions', {
                    topic: selectedTopic,
                    count: count,
                    seed: Math.random()
                });

                let questions = null;
                if (Array.isArray(response)) questions = response;
                else if (response.json && Array.isArray(response.json)) questions = response.json;
                else if (Array.isArray(response.data)) questions = response.data;
                else if (response[0] && response[0].json) questions = response[0].json;

                if (!Array.isArray(questions)) throw new Error("Format Error");
                currentQuestions = questions;
                renderQuestion();
            } catch (err) {
                const fallbacks = {
                    calculus: [
                        { question: "Derivative of x²?", options: ["x", "2x", "x²", "2"], answer: "2x" },
                        { question: "Limit of 1/x as x -> ∞?", options: ["0", "1", "∞", "Undef"], answer: "0" },
                        { question: "Integral of 2x?", options: ["x²", "2x", "x", "1"], answer: "x²" },
                        { question: "d/dx (sin x)?", options: ["cos x", "sin x", "tan x", "1"], answer: "cos x" },
                        { question: "Slope of y=5x?", options: ["5", "x", "0", "1"], answer: "5" },
                        { question: "Integral of 1/x?", options: ["ln(x)", "e^x", "x", "1"], answer: "ln(x)" },
                        { question: "d/dx (5)?", options: ["0", "5", "1", "x"], answer: "0" },
                        { question: "Derivative of e^x?", options: ["e^x", "x", "1", "0"], answer: "e^x" },
                        { question: "Value of π?", options: ["3.14", "2.71", "1.61", "0"], answer: "3.14" },
                        { question: "2 + 2?", options: ["4", "5", "6", "1"], answer: "4" }
                    ],
                    math: [
                        { question: "√225?", options: ["15", "12", "25", "20"], answer: "15" },
                        { question: "7 * 8?", options: ["56", "54", "64", "62"], answer: "56" },
                        { question: "Solve 2x=10", options: ["5", "10", "2", "20"], answer: "5" },
                        { question: "10% of 500?", options: ["50", "5", "100", "500"], answer: "50" },
                        { question: "Angles in triangle?", options: ["180", "90", "360", "270"], answer: "180" },
                        { question: "Square of 12?", options: ["144", "121", "169", "100"], answer: "144" },
                        { question: "Which is prime?", options: ["7", "4", "9", "10"], answer: "7" },
                        { question: "Cube of 2?", options: ["8", "4", "6", "2"], answer: "8" },
                        { question: "Half of 150?", options: ["75", "50", "100", "25"], answer: "75" },
                        { question: "Binary 10?", options: ["2", "1", "0", "10"], answer: "2" }
                    ],
                    logic: [
                        { question: "2, 4, 8, ?", options: ["16", "10", "12", "14"], answer: "16" },
                        { question: "A taller than B, B taller than C, shortest?", options: ["C", "B", "A", "None"], answer: "C" },
                        { question: "Opposite of Up?", options: ["Down", "Left", "Right", "High"], answer: "Down" },
                        { question: "If All A are B, and All B are C, then...?", options: ["All A are C", "Some A are C", "No A are C", "None"], answer: "All A are C" },
                        { question: "Next number: 1, 1, 2, 3, 5, ?", options: ["8", "7", "9", "10"], answer: "8" },
                        { question: "Odd one out: Apple, Orange, Carrot, Banana?", options: ["Carrot", "Apple", "Orange", "Banana"], answer: "Carrot" },
                        { question: "Light is to Bright as Dark is to...?", options: ["Dim", "Darker", "Black", "Cold"], answer: "Dim" },
                        { question: "Brother of your mother is your...?", options: ["Uncle", "Nephew", "Father", "Cousin"], answer: "Uncle" },
                        { question: "Clock is to Time as Thermometer is to...?", options: ["Temperature", "Weather", "Heat", "Cold"], answer: "Temperature" },
                        { question: "Next number in sequence: 10, 20, 30, ?", options: ["40", "50", "60", "35"], answer: "40" }
                    ],
                    language: [
                        { question: "Find the Noun:", options: ["Table", "Run", "Slow", "Fast"], answer: "Table" },
                        { question: "Plural of Mice?", options: ["Mice", "Mouses", "Mouse", "Mices"], answer: "Mice" },
                        { question: "Find the verb: 'The cat sat on the mat.'", options: ["Sat", "Cat", "Mat", "The"], answer: "Sat" },
                        { question: "Synonym of 'Fast'?", options: ["Quick", "Slow", "Steady", "Heavy"], answer: "Quick" },
                        { question: "Antonym of 'Hot'?", options: ["Cold", "Warm", "Burning", "Dry"], answer: "Cold" },
                        { question: "'She ___ her homework yesterday.'", options: ["Did", "Do", "Does", "Doing"], answer: "Did" },
                        { question: "Collective noun for birds?", options: ["Flock", "Herd", "Swarm", "Pack"], answer: "Flock" },
                        { question: "Choose the adjective: 'The blue sky.'", options: ["Blue", "Sky", "The", "Color"], answer: "Blue" },
                        { question: "He is ___ tallest boy.", options: ["The", "A", "An", "None"], answer: "The" },
                        { question: "Is 'Beautifully' an Adverb or Noun?", options: ["Adverb", "Noun", "Verb", "Adjective"], answer: "Adverb" }
                    ],
                    comprehension: [
                        { question: "What is the main idea of a text?", options: ["The central message", "The font size", "The author's name", "The price"], answer: "The central message" },
                        { question: "In reading, an 'Inference' is...?", options: ["An educated guess", "A summary", "A title", "A mistake"], answer: "An educated guess" },
                        { question: "What is the purpose of a 'Conclusion'?", options: ["To summarize main points", "To start the story", "To introduce characters", "To give a hook"], answer: "To summarize main points" },
                        { question: "What does 'Context Clues' help with?", options: ["Finding word meanings", "Checking spelling", "Counting pages", "Printing"], answer: "Finding word meanings" },
                        { question: "A 'Protagonist' is...?", options: ["The main character", "The villain", "The narrator", "The setting"], answer: "The main character" },
                        { question: "What is 'Tone' in writing?", options: ["The author's attitude", "The volume", "The paper quality", "The ink color"], answer: "The author's attitude" },
                        { question: "What follows the 'Climax' in a plot?", options: ["Falling Action", "Introduction", "Rising Action", "Title"], answer: "Falling Action" },
                        { question: "A 'Simile' uses which words?", options: ["Like or As", "No or Not", "Because", "But"], answer: "Like or As" },
                        { question: "What is 'Point of View'?", options: ["Who is telling the story", "Where the story is", "When the story ends", "Why it was written"], answer: "Who is telling the story" },
                        { question: "Expository writing aims to...?", options: ["Inform/Explain", "Persuade", "Entertain", "Poem"], answer: "Inform/Explain" }
                    ],
                    vocabulary: [
                        { question: "Synonym of 'Vivid'?", options: ["Clear/Bright", "Blurry", "Old", "Dark"], answer: "Clear/Bright" },
                        { question: "Antonym of 'Gigantic'?", options: ["Tiny", "Large", "Huge", "Heavy"], answer: "Tiny" },
                        { question: "What does 'Benevolent' mean?", options: ["Kind", "Evil", "Smart", "Fast"], answer: "Kind" },
                        { question: "Meaning of 'Ephemeral'?", options: ["Short-lived", "Permanent", "Large", "Bright"], answer: "Short-lived" },
                        { question: "Synonym of 'Fragile'?", options: ["Delicate", "Strong", "Heavy", "Solid"], answer: "Delicate" },
                        { question: "What is a 'Cacophony'?", options: ["Harsh noise", "Soft music", "Silence", "A bird"], answer: "Harsh noise" },
                        { question: "Meaning of 'Luminous'?", options: ["Shining", "Dark", "Silent", "Heavy"], answer: "Shining" },
                        { question: "Antonym of 'Wealthy'?", options: ["Poor", "Rich", "Happy", "Sad"], answer: "Poor" },
                        { question: "What is a 'Sovereign'?", options: ["Supreme ruler", "Servant", "Child", "Animal"], answer: "Supreme ruler" },
                        { question: "Synonym of 'Ancient'?", options: ["Very old", "Modern", "New", "Fast"], answer: "Very old" }
                    ]
                };
                let pool = fallbacks[selectedTopic] || fallbacks['calculus'];
                currentQuestions = [...pool].sort(() => Math.random() - 0.5).slice(0, count);
                renderQuestion();
            }
        });

        function renderQuestion() {
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('question-container').classList.remove('hidden');
            const q = currentQuestions[currentIdx];
            document.getElementById('progress-text').innerText = `Question ${currentIdx + 1} / ${currentQuestions.length}`;
            document.getElementById('progress-bar').style.width = `${((currentIdx + 1) / currentQuestions.length) * 100}%`;
            document.getElementById('question-text').innerText = q.question;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-5 rounded-2xl text-slate-200 font-medium flex items-center justify-between group";
                btn.innerHTML = `<span>${opt}</span><div class="w-5 h-5 border-2 border-white/10 rounded-full flex items-center justify-center group-[.selected]:border-blue-500"><div class="w-2.5 h-2.5 bg-blue-500 rounded-full scale-0 transition-transform group-[.selected]:scale-100"></div></div>`;
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById('next-btn').disabled = false;
                    userAnswers[currentIdx] = opt;
                };
                container.appendChild(btn);
            });
            document.getElementById('next-btn-text').innerText = (currentIdx === currentQuestions.length - 1) ? "Submit Final Result" : "Next Question";
        }

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentIdx < currentQuestions.length - 1) {
                currentIdx++;
                document.getElementById('next-btn').disabled = true;
                renderQuestion();
            } else {
                completeQuiz();
            }
        });

        async function completeQuiz() {
            showView('quiz-view');
            document.getElementById('question-container').classList.add('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');
            let score = 0;
            currentQuestions.forEach((q, idx) => { if (userAnswers[idx] === q.answer) score++; });
            const final = (score / currentQuestions.length) * 100;

            // SAVE TO MYSQL BACKEND
            try {
                await callBackend('/scores', 'POST', {
                    email: userEmail,
                    score: final,
                    topic: selectedTopic
                });
            } catch (e) {
                console.error("Failed to save score to MySQL:", e);
            }

            document.getElementById('final-score').innerText = `${final.toFixed(0)}%`;
            document.getElementById('user-display-email').innerText = userEmail;
            showView('results-view');
        }
        lucide.createIcons();
    </script>
</body>

</html>